# Student Registration Portal - Complete Implementation Guide

## Overview

This guide provides step-by-step instructions to set up and use the complete Student Registration Portal system with Supabase integration, including:

- ‚úÖ Multi-step registration form with full validation
- ‚úÖ Automatic admission number generation
- ‚úÖ File uploads (Passport photo, birth certificate, ID proof)
- ‚úÖ Admin approval workflow
- ‚úÖ Responsive UI with Tailwind CSS + Radix UI
- ‚úÖ Row-Level Security (RLS) policies

---

## üóÑÔ∏è Database Setup

### Step 1: Execute SQL Migrations

1. Open **Supabase Dashboard** ‚Üí **SQL Editor**
2. Copy the contents of `lib/student-registration-complete.sql`
3. Execute the SQL to create/update:
   - Enhanced `students` table with new fields
   - Auto-admission number generation trigger
   - Document tracking tables
   - Approval workflow tables
   - RLS policies

### Step 2: Create Storage Bucket

1. Go to **Supabase Dashboard** ‚Üí **Storage**
2. Create a new bucket named `student-documents`
3. Set policies:

```sql
-- Public read (optional, for viewing documents)
CREATE POLICY "Public Read" ON storage.objects
  FOR SELECT USING (bucket_id = 'student-documents');

-- Students can upload their own documents
CREATE POLICY "Students Upload Own Documents" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'student-documents' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );
```

4. **Important**: Set Bucket Visibility to **Public** if you want direct file access, or **Private** for secure access through policies

---

## üìù Form Fields Reference

### Account Information
- Email (required, unique validation)
- Password (min 8 chars, uppercase + lowercase + numbers)
- Confirm Password

### Personal Information
- First Name (2-50 chars)
- Last Name (2-50 chars)
- Gender (Male, Female, Other)
- Date of Birth (5-25 age range validation)

### Contact Information
- Phone (10+ chars, phone format validation)
- Address (5-255 chars)
- State (Nigerian states list)
- LGA (2-100 chars)

### Guardian Information
- Guardian Full Name (2-100 chars)
- Guardian Phone (10+ chars)
- Guardian Email (valid email format)
- Guardian Relationship (Father, Mother, Guardian, etc.)

### Academic Information
- Class (Optional - can be assigned later)
- Previous School (Optional)

### Documents (Optional but Recommended)
- Passport Photo (PNG, JPG, WebP, max 5MB)
- Birth Certificate (PDF, PNG, JPG, max 5MB)
- ID Proof (PDF, PNG, JPG, max 5MB)

---

## üöÄ Features

### ‚úÖ Auto-Generated Admission Numbers

Format: `STD-YYMMDD-####`
- Example: `STD-250121-0001`
- Automatically generated on student creation
- Unique per student
- Stored in database

**Generated by:** Database trigger `auto_generate_admission_number`

### ‚úÖ File Upload System

- **Storage Location:** Supabase Storage ‚Üí `student-documents/{user_id}/`
- **Supported Formats:**
  - Passport Photo: PNG, JPG, WebP
  - Other Documents: PDF, PNG, JPG
- **Max Size:** 5MB per file
- **URLs:** Stored in student records for future reference

**Implementation:** `uploadStudentDocuments()` in `lib/student-registration-service.ts`

### ‚úÖ Admin Approval Workflow

**Flow:**
1. Student registers ‚Üí `approved = false` (pending)
2. Admin reviews ‚Üí `/admin/registrations`
3. Admin approves ‚Üí `approved = true`, creates approval record
4. Student can now login
5. Record stored in `student_approvals` table

**Admin Page:** `/admin/registrations`

**Features:**
- View pending registrations
- Search and filter students
- View detailed student information
- Download/view uploaded documents
- Approve with optional comments
- Reject with mandatory reason

---

## üìö API Routes & Services

### Registration Services (`lib/student-registration-service.ts`)

#### `registerStudent(formData, files?)`
Creates new student with auth user and uploads documents
```typescript
const result = await registerStudent(formData, { photo, birthCertificate, idProof });
// Returns: { success, userId, studentId, admissionNumber, message }
```

#### `uploadStudentDocuments(userId, files)`
Uploads files to Supabase Storage
```typescript
const urls = await uploadStudentDocuments(userId, files);
// Returns: { photoUrl, birthCertificateUrl, idProofUrl }
```

#### `getPendingStudents()`
Fetches all pending registrations for admin
```typescript
const students = await getPendingStudents();
```

#### `getStudentWithDocuments(studentId)`
Fetches complete student profile with documents
```typescript
const { student, documents, approval } = await getStudentWithDocuments(studentId);
```

#### `approveStudent(studentId, adminId, comments?)`
Approves student registration
```typescript
const result = await approveStudent(studentId, adminId, 'Approved');
```

#### `rejectStudent(studentId, adminId, reason)`
Rejects student registration
```typescript
const result = await rejectStudent(studentId, adminId, 'Missing documents');
```

#### `getStudentRegistrationStats()`
Returns registration statistics for dashboard
```typescript
const stats = await getStudentRegistrationStats();
// Returns: { total, approved, pending, rejected }
```

---

## üîê Authentication & Security

### Row-Level Security (RLS)

All tables have RLS enabled:

1. **Students Table**
   - Students can view own record
   - Teachers can view their class students
   - Admins can view all students

2. **Documents Table**
   - Students can view/upload own documents
   - Admins can view all documents

3. **Approvals Table**
   - Students can view own approval status
   - Admins can manage all approvals

### Password Security
- Minimum 8 characters
- Must contain uppercase, lowercase, and numbers
- Hashed by Supabase Auth
- Not stored in plain text

### Email Verification
- Supabase Auth handles email verification
- Enabled by default (check Supabase Auth settings)
- Optional confirmation before login

---

## üì± User Experience

### Step-by-Step Form Navigation

```
Step 1: Account ‚Üí Step 2: Personal ‚Üí Step 3: Contact ‚Üí 
Step 4: Guardian ‚Üí Step 5: Academic ‚Üí Step 6: Documents ‚Üí Submit
```

- Visual progress indicator
- Field validation on blur
- Error messages in real-time
- Can navigate between completed steps
- Document uploads are optional

### Success Flow

1. **Registration Complete**
   - Toast notification with admission number
   - Redirect to login page with message
   - Student account created but not active (pending approval)

2. **Admin Approval**
   - Admin reviews documents
   - Approves or rejects
   - System creates approval record
   - Email notification (optional feature to add)

3. **Student Access**
   - After approval, student can login
   - Access student dashboard
   - View their records

---

## üõ†Ô∏è API Endpoints

### Auth Endpoints
- `POST /api/auth/signup` - Create new account
- `POST /api/auth/login` - Login
- `POST /api/auth/logout` - Logout
- `POST /api/auth/otp/request` - Request OTP
- `POST /api/auth/otp/verify` - Verify OTP

### Student Endpoints
- `GET /api/student/profile` - Get student profile
- `GET /api/student/overview` - Student dashboard data
- `GET /api/student/attendance` - Student attendance records
- `GET /api/student/results` - Student results
- `GET /api/student/assignments` - Student assignments
- `GET /api/student/payments` - Student payment records

### Admin Endpoints
- `GET /api/admin/users` - List all users
- `GET /api/admin/overview` - Admin dashboard
- `GET /api/admin/classes` - List classes
- `GET /api/admin/subjects` - List subjects

---

## üé® Styling

### Color Scheme (El Bethel Academy)

**Primary Colors:**
- Primary Blue: `#1e40af`
- Secondary Gold: `#eab308`

**Neutral Colors:**
- Background: Light gray
- Text: Dark gray (#1f2937)
- Border: Light gray (#e5e7eb)

### Responsive Design

- Mobile: Single column
- Tablet: 2 columns (640px+)
- Desktop: Full width with 2-col grids

### Components Used

- **Radix UI** for accessible components
- **Tailwind CSS** for styling
- **Lucide React** for icons
- **React Hook Form** for form handling
- **Zod** for validation
- **Sonner** for notifications

---

## üß™ Testing Checklist

### Registration Form Tests
- [ ] All required fields have proper validation
- [ ] Password complexity validation works
- [ ] Email uniqueness check works
- [ ] File uploads with size validation
- [ ] Form progression between steps
- [ ] Submit creates user in auth
- [ ] Student record created with all fields
- [ ] Admission number auto-generated
- [ ] Approval record created

### Admin Approval Tests
- [ ] Admin can view pending students
- [ ] Admin can view student details
- [ ] Admin can view uploaded documents
- [ ] Admin can approve with comments
- [ ] Admin can reject with reason
- [ ] Student status updates after approval
- [ ] Stats display correct counts

### Security Tests
- [ ] RLS policies enforce access
- [ ] Students can't view other students
- [ ] Only admins can approve/reject
- [ ] Password requirements enforced
- [ ] Email uniqueness enforced

---

## üö® Troubleshooting

### Issue: "Admission number not generating"
**Solution:** Ensure the trigger exists:
```sql
SELECT * FROM pg_trigger WHERE tgname = 'auto_generate_admission_number';
```

### Issue: "Storage bucket not found"
**Solution:** Create bucket via Supabase dashboard:
- Storage ‚Üí Create Bucket ‚Üí Name: `student-documents`

### Issue: "RLS policy blocking access"
**Solution:** Check user has correct role:
```sql
SELECT role FROM users WHERE email = 'student@example.com';
```

### Issue: "File upload fails"
**Solution:** Verify bucket public access and CORS settings in Supabase

---

## üìã Database Schema Summary

### Tables Created/Modified

1. **students** - Student profile (updated with new fields)
2. **student_documents** - Track uploaded files
3. **student_approvals** - Approval workflow tracking
4. **users** - Auth users (linked via user_id)
5. **classes** - Class references

### Key Functions

- `generate_admission_number()` - Auto-generates admission numbers
- `approve_student_registration()` - RPC function for approval
- `reject_student_registration()` - RPC function for rejection

### Key Views

- `pending_student_registrations` - View for admin dashboard

---

## üîÑ Next Steps & Enhancements

### Phase 2 Features (Future)
- [ ] Email notifications on approval/rejection
- [ ] SMS notifications
- [ ] Student self-service document re-upload
- [ ] Batch import from Excel
- [ ] Parent/Guardian login
- [ ] Document expiry tracking
- [ ] Auto-class assignment based on age/grade
- [ ] Payment integration with approvals
- [ ] Multi-language support
- [ ] Advanced analytics dashboard

### Configuration

To enable optional features, check:

1. **Email Notifications** ‚Üí Set up Supabase Functions
2. **SMS** ‚Üí Configure SMS provider (Twilio, etc.)
3. **Payment** ‚Üí Integrate payment provider
4. **Auto-Class Assignment** ‚Üí Modify approval workflow

---

## üìû Support

For issues or questions:

1. Check the troubleshooting section above
2. Review Supabase documentation: https://supabase.com/docs
3. Check application logs in Supabase Dashboard
4. Review form validation: `lib/student-registration-validation.ts`

---

## üìÑ Files Reference

| File | Purpose |
|------|---------|
| `app/register/student/page.tsx` | Student registration form |
| `app/admin/registrations/page.tsx` | Admin approval interface |
| `lib/student-registration-service.ts` | Core business logic |
| `lib/student-registration-validation.ts` | Form validation schemas |
| `lib/student-registration-complete.sql` | Database migrations |
| `lib/supabase-client.ts` | Supabase client initialization |

---

## Version History

- **v1.0** (2025-01-21)
  - Multi-step registration form
  - Auto-admission numbers
  - File uploads
  - Admin approval workflow
  - Complete RLS security

---

**Last Updated:** 2025-01-21
**Maintained By:** Development Team
**Status:** Production Ready ‚úÖ
